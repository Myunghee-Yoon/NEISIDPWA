<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>출석부-나이스ID 매칭 앱</title>
    
    <!-- PWA 메타 태그 -->
    <meta name="theme-color" content="#4facfe">
    <meta name="description" content="출석부 데이터와 나이스ID 데이터를 매칭하여 결과를 생성하는 앱입니다.">
    <link rel="manifest" href="./manifest.json">
    
    <!-- PWA 지원 -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="매칭앱">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .upload-box {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .upload-box:hover {
            border-color: #4facfe;
            background: #f0f8ff;
            transform: translateY(-2px);
        }

        .upload-box h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
            display: inline-block;
            text-decoration: none;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }

        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 8px;
            color: #2e7d32;
            font-weight: 500;
        }

        .input-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            border: 2px solid #e3f2fd;
            display: none;
        }

        .input-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }

        .input-group input,
        .input-group select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .process-section {
            text-align: center;
            margin: 40px 0;
        }

        .process-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 30px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .process-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .process-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .results-section {
            margin-top: 40px;
            display: none;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .results-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .results-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .no-match {
            color: #d32f2f;
            font-weight: 500;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .download-btn {
            background: #4caf50;
            color: white;
        }

        .copy-btn {
            background: #2196f3;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: #f44336;
        }

        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }
            
            .input-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>출석부-나이스ID 매칭 시스템</h1>
            <p>출석부 데이터와 나이스ID 데이터를 매칭하여 결과를 생성합니다</p>
        </div>

        <div class="content">
            <div class="upload-section">
                <div class="upload-box">
                    <h3>📋 출석부 파일</h3>
                    <p>프로그램명, 학교명, 시작일, 이름 등이 포함된 파일</p>
                    <br>
                    <label for="attendanceFile" class="upload-btn">파일 선택</label>
                    <input type="file" id="attendanceFile" class="file-input" accept=".xlsx,.xls" />
                    <div id="attendanceInfo" class="file-info" style="display: none;"></div>
                </div>

                <div class="upload-box">
                    <h3>🆔 나이스ID 파일</h3>
                    <p>번호, 성명, 재단종합교육연수원ID, 나이스번호가 포함된 파일</p>
                    <br>
                    <label for="niceFile" class="upload-btn">파일 선택</label>
                    <input type="file" id="niceFile" class="file-input" accept=".xlsx,.xls" />
                    <div id="niceInfo" class="file-info" style="display: none;"></div>
                </div>
            </div>

            <!-- 추가 정보 입력 섹션 -->
            <div class="input-section" id="inputSection">
                <h3>📝 추가 정보 입력</h3>
                <div class="input-grid">
                    <div class="input-group">
                        <label for="programNameInput">프로그램명</label>
                        <select id="programNameInput">
                            <option value="">선택하세요</option>
                            <option value="우리학교 알아보기(1기)">우리학교 알아보기(1기)</option>
                            <option value="학교의 지속가능 리더십 함양(1기)">학교의 지속가능 리더십 함양(1기)</option>
                            <option value="디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(1기)">디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(1기)</option>
                            <option value="데이터 기반 현장 연구 지원(1기)">데이터 기반 현장 연구 지원(1기)</option>
                            <option value="교과별 전문과정(1기)">교과별 전문과정(1기)</option>
                            <option value="주제별 심화과정(1기)">주제별 심화과정(1기)</option>
                            <option value="학교 교육과정 평가-환류(1기)">학교 교육과정 평가-환류(1기)</option>
                            <option value="우리학교 알아보기(2기)">우리학교 알아보기(2기)</option>
                            <option value="학교의 지속가능 리더십 함양(2기)">학교의 지속가능 리더십 함양(2기)</option>
                            <option value="디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(2기)">디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(2기)</option>
                            <option value="데이터 기반 현장 연구 지원(2기)">데이터 기반 현장 연구 지원(2기)</option>
                            <option value="교과별 전문과정(2기)">교과별 전문과정(2기)</option>
                            <option value="주제별 심화과정(2기)">주제별 심화과정(2기)</option>
                            <option value="학교 교육과정 평가-환류(2기)">학교 교육과정 평가-환류(2기)</option>
                            <option value="우리학교 알아보기(3기)">우리학교 알아보기(3기)</option>
                            <option value="학교의 지속가능 리더십 함양(3기)">학교의 지속가능 리더십 함양(3기)</option>
                            <option value="디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(3기)">디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(3기)</option>
                            <option value="데이터 기반 현장 연구 지원(3기)">데이터 기반 현장 연구 지원(3기)</option>
                            <option value="교과별 전문과정(3기)">교과별 전문과정(3기)</option>
                            <option value="주제별 심화과정(3기)">주제별 심화과정(3기)</option>
                            <option value="학교 교육과정 평가-환류(3기)">학교 교육과정 평가-환류(3기)</option>
                            <option value="우리학교 알아보기(4기)">우리학교 알아보기(4기)</option>
                            <option value="학교의 지속가능 리더십 함양(4기)">학교의 지속가능 리더십 함양(4기)</option>
                            <option value="디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(4기)">디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(4기)</option>
                            <option value="데이터 기반 현장 연구 지원(4기)">데이터 기반 현장 연구 지원(4기)</option>
                            <option value="교과별 전문과정(4기)">교과별 전문과정(4기)</option>
                            <option value="주제별 심화과정(4기)">주제별 심화과정(4기)</option>
                            <option value="학교 교육과정 평가-환류(4기)">학교 교육과정 평가-환류(4기)</option>
                            <option value="우리학교 알아보기(5기)">우리학교 알아보기(5기)</option>
                            <option value="학교의 지속가능 리더십 함양(5기)">학교의 지속가능 리더십 함양(5기)</option>
                            <option value="디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(5기)">디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(5기)</option>
                            <option value="데이터 기반 현장 연구 지원(5기)">데이터 기반 현장 연구 지원(5기)</option>
                            <option value="교과별 전문과정(5기)">교과별 전문과정(5기)</option>
                            <option value="주제별 심화과정(5기)">주제별 심화과정(5기)</option>
                            <option value="학교 교육과정 평가-환류(5기)">학교 교육과정 평가-환류(5기)</option>
                            <option value="우리학교 알아보기(6기)">우리학교 알아보기(6기)</option>
                            <option value="학교의 지속가능 리더십 함양(6기)">학교의 지속가능 리더십 함양(6기)</option>
                            <option value="디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(6기)">디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(6기)</option>
                            <option value="데이터 기반 현장 연구 지원(6기)">데이터 기반 현장 연구 지원(6기)</option>
                            <option value="교과별 전문과정(6기)">교과별 전문과정(6기)</option>
                            <option value="주제별 심화과정(6기)">주제별 심화과정(6기)</option>
                            <option value="학교 교육과정 평가-환류(6기)">학교 교육과정 평가-환류(6기)</option>
                            <option value="우리학교 알아보기(7기)">우리학교 알아보기(7기)</option>
                            <option value="학교의 지속가능 리더십 함양(7기)">학교의 지속가능 리더십 함양(7기)</option>
                            <option value="디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(7기)">디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(7기)</option>
                            <option value="데이터 기반 현장 연구 지원(7기)">데이터 기반 현장 연구 지원(7기)</option>
                            <option value="교과별 전문과정(7기)">교과별 전문과정(7기)</option>
                            <option value="주제별 심화과정(7기)">주제별 심화과정(7기)</option>
                            <option value="학교 교육과정 평가-환류(7기)">학교 교육과정 평가-환류(7기)</option>
                            <option value="우리학교 알아보기(8기)">우리학교 알아보기(8기)</option>
                            <option value="학교의 지속가능 리더십 함양(8기)">학교의 지속가능 리더십 함양(8기)</option>
                            <option value="디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(8기)">디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(8기)</option>
                            <option value="데이터 기반 현장 연구 지원(8기)">데이터 기반 현장 연구 지원(8기)</option>
                            <option value="교과별 전문과정(8기)">교과별 전문과정(8기)</option>
                            <option value="주제별 심화과정(8기)">주제별 심화과정(8기)</option>
                            <option value="학교 교육과정 평가-환류(8기)">학교 교육과정 평가-환류(8기)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="operationInput">운영 차시</label>
                        <input type="number" id="operationInput" placeholder="예: 3" min="1" />
                    </div>
                    <div class="input-group">
                        <label for="regionInput">지역</label>
                        <select id="regionInput">
                            <option value="">선택하세요</option>
                            <option value="서울특별시">서울특별시</option>
                            <option value="부산광역시">부산광역시</option>
                            <option value="대구광역시">대구광역시</option>
                            <option value="인천광역시">인천광역시</option>
                            <option value="광주광역시">광주광역시</option>
                            <option value="대전광역시">대전광역시</option>
                            <option value="울산광역시">울산광역시</option>
                            <option value="세종특별자치시">세종특별자치시</option>
                            <option value="경기도">경기도</option>
                            <option value="강원특별자치도">강원특별자치도</option>
                            <option value="충청북도">충청북도</option>
                            <option value="충청남도">충청남도</option>
                            <option value="전북특별자치도">전북특별자치도</option>
                            <option value="전라남도">전라남도</option>
                            <option value="경상북도">경상북도</option>
                            <option value="경상남도">경상남도</option>
                            <option value="제주특별자치도">제주특별자치도</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="schoolNameInput">학교명</label>
                        <input type="text" id="schoolNameInput" placeholder="예: 서울초등학교" />
                    </div>
                </div>
            </div>

            <div class="process-section">
                <button class="process-btn" id="processBtn" onclick="processFiles()" disabled>
                    🔄 데이터 매칭 시작
                </button>
            </div>

            <div class="results-section" id="resultsSection">
                <div class="action-buttons">
                    <button class="action-btn download-btn" onclick="downloadResults()">
                        💾 엑셀 다운로드
                    </button>
                    <button class="action-btn copy-btn" onclick="copyToClipboard()">
                        📋 클립보드 복사
                    </button>
                </div>

                <div style="overflow-x: auto;">
                    <table class="results-table" id="resultsTable">
                        <thead>
                            <tr>
                                <th>과목코드</th>
                                <th>성명</th>
                                <th>ID</th>
                                <th>나이스 번호</th>
                                <th>오프라인 성적</th>
                                <th>과제 점수</th>
                                <th>기수</th>
                                <th>차시</th>
                                <th>운영기관</th>
                                <th>지역</th>
                                <th>학교명</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let attendanceData = null;
        let niceData = null;
        let matchedResults = [];

        // 파일 입력 이벤트 설정
        document.addEventListener('DOMContentLoaded', function() {
            // 출석부 파일 이벤트
            document.getElementById('attendanceFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('attendanceInfo').style.display = 'block';
                    document.getElementById('attendanceInfo').textContent = `선택된 파일: ${file.name}`;
                    readExcelFile(file, 'attendance');
                }
            });

            // 나이스ID 파일 이벤트
            document.getElementById('niceFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('niceInfo').style.display = 'block';
                    document.getElementById('niceInfo').textContent = `선택된 파일: ${file.name}`;
                    readExcelFile(file, 'nice');
                }
            });
        });

        // 엑셀 파일 읽기
        function readExcelFile(file, type) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (type === 'attendance') {
                    attendanceData = jsonData;
                    console.log('출석부 데이터 로드됨:', attendanceData.length, '행');
                } else {
                    niceData = jsonData;
                    console.log('나이스ID 데이터 로드됨:', niceData.length, '행');
                }
                
                checkProcessReady();
            };
            reader.readAsArrayBuffer(file);
        }

        // 처리 준비 상태 확인
        function checkProcessReady() {
            const processBtn = document.getElementById('processBtn');
            if (attendanceData && niceData) {
                processBtn.disabled = false;
                processBtn.textContent = '🔄 데이터 매칭 시작';
                document.getElementById('inputSection').style.display = 'block';
            }
        }

        // 데이터 처리
        function processFiles() {
            const programNameInput = document.getElementById('programNameInput').value.trim();
            const operationInput = document.getElementById('operationInput').value.trim();
            const regionInput = document.getElementById('regionInput').value;
            const schoolNameInput = document.getElementById('schoolNameInput').value.trim();

            if (!programNameInput || !operationInput || !regionInput || !schoolNameInput) {
                showToast('모든 필드를 입력해주세요.', 'error');
                return;
            }

            try {
                matchedResults = matchData(programNameInput, operationInput, regionInput, schoolNameInput);
                displayResults();
                document.getElementById('resultsSection').style.display = 'block';
                showToast('매칭이 완료되었습니다!');
            } catch (error) {
                console.error('처리 오류:', error);
                showToast('처리 중 오류가 발생했습니다.', 'error');
            }
        }

        // 데이터 매칭 로직
        function matchData(programNameInput, operationInput, regionInput, schoolNameInput) {
            const results = [];
            
            // 과목코드 매핑 테이블
            const subjectCodeMapping = {
                '우리학교 알아보기(1기)': '1000',
                '학교의 지속가능 리더십 함양(1기)': '1001',
                '디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(1기)': '1004',
                '데이터 기반 현장 연구 지원(1기)': '1005',
                '교과별 전문과정(1기)': '1006',
                '주제별 심화과정(1기)': '1007',
                '학교 교육과정 평가-환류(1기)': '1008',
                '우리학교 알아보기(2기)': '2000',
                '학교의 지속가능 리더십 함양(2기)': '2001',
                '디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(2기)': '2004',
                '데이터 기반 현장 연구 지원(2기)': '2005',
                '교과별 전문과정(2기)': '2006',
                '주제별 심화과정(2기)': '2007',
                '학교 교육과정 평가-환류(2기)': '2008',
                '우리학교 알아보기(3기)': '3000',
                '학교의 지속가능 리더십 함양(3기)': '3001',
                '디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(3기)': '3004',
                '데이터 기반 현장 연구 지원(3기)': '3005',
                '교과별 전문과정(3기)': '3006',
                '주제별 심화과정(3기)': '3007',
                '학교 교육과정 평가-환류(3기)': '3008',
                '우리학교 알아보기(4기)': '4000',
                '학교의 지속가능 리더십 함양(4기)': '4001',
                '디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(4기)': '4004',
                '데이터 기반 현장 연구 지원(4기)': '4005',
                '교과별 전문과정(4기)': '4006',
                '주제별 심화과정(4기)': '4007',
                '학교 교육과정 평가-환류(4기)': '4008',
                '우리학교 알아보기(5기)': '5000',
                '학교의 지속가능 리더십 함양(5기)': '5001',
                '디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(5기)': '5004',
                '데이터 기반 현장 연구 지원(5기)': '5005',
                '교과별 전문과정(5기)': '5006',
                '주제별 심화과정(5기)': '5007',
                '학교 교육과정 평가-환류(5기)': '5008',
                '우리학교 알아보기(6기)': '6000',
                '학교의 지속가능 리더십 함양(6기)': '6001',
                '디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(6기)': '6004',
                '데이터 기반 현장 연구 지원(6기)': '6005',
                '교과별 전문과정(6기)': '6006',
                '주제별 심화과정(6기)': '6007',
                '학교 교육과정 평가-환류(6기)': '6008',
                '우리학교 알아보기(7기)': '7000',
                '학교의 지속가능 리더십 함양(7기)': '7001',
                '디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(7기)': '7004',
                '데이터 기반 현장 연구 지원(7기)': '7005',
                '교과별 전문과정(7기)': '7006',
                '주제별 심화과정(7기)': '7007',
                '학교 교육과정 평가-환류(7기)': '7008',
                '우리학교 알아보기(8기)': '8000',
                '학교의 지속가능 리더십 함양(8기)': '8001',
                '디지털 교육 도구 활용 및 기술적 애로사항 해소 지원(8기)': '8004',
                '데이터 기반 현장 연구 지원(8기)': '8005',
                '교과별 전문과정(8기)': '8006',
                '주제별 심화과정(8기)': '8007',
                '학교 교육과정 평가-환류(8기)': '8008'
            };

            // 기수 추출 함수
            function extractKisu(programName) {
                const match = programName.match(/\((\d+)기\)/);
                return match ? match[1] : '';
            }
            
            // 나이스 데이터를 맵으로 변환
            const niceMap = new Map();
            for (let i = 1; i < niceData.length; i++) {
                const row = niceData[i];
                if (row[1]) {
                    niceMap.set(row[1].toString().trim(), {
                        number: row[0] || '',
                        name: row[1],
                        foundationId: row[2] || '',
                        niceId: row[3] || ''
                    });
                }
            }
            
            // 출석부 데이터 처리
            for (let i = 1; i < attendanceData.length; i++) {
                const row = attendanceData[i];
                const participantName = row[3] || '';
                
                if (!participantName || participantName.toString().trim() === '') {
                    continue;
                }
                
                const matchedData = niceMap.get(participantName.toString().trim());
                const foundationId = matchedData ? matchedData.foundationId : '매칭된 이름 없음';
                const niceId = matchedData ? matchedData.niceId : '매칭된 이름 없음';
                
                const subjectCode = subjectCodeMapping[programNameInput] || '';
                const kisu = extractKisu(programNameInput);
                
                results.push({
                    subjectCode: subjectCode,
                    participantName: participantName.toString().trim(),
                    foundationId: foundationId,
                    niceId: niceId,
                    offlineScore: '',  // 오프라인 성적 (빈칸)
                    assignmentScore: '',  // 과제 점수 (빈칸)
                    kisu: kisu,
                    operation: operationInput,
                    organization: 'kt cs',
                    region: regionInput,
                    schoolName: schoolNameInput
                });
            }
            
            return results;
        }

        // 결과 표시
        function displayResults() {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            
            matchedResults.forEach(result => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${result.subjectCode}</td>
                    <td>${result.participantName}</td>
                    <td class="${result.foundationId === '매칭된 이름 없음' ? 'no-match' : ''}">${result.foundationId}</td>
                    <td class="${result.niceId === '매칭된 이름 없음' ? 'no-match' : ''}">${result.niceId}</td>
                    <td>${result.offlineScore}</td>
                    <td>${result.assignmentScore}</td>
                    <td>${result.kisu}</td>
                    <td>${result.operation}</td>
                    <td>${result.organization}</td>
                    <td>${result.region}</td>
                    <td>${result.schoolName}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 엑셀 다운로드
        function downloadResults() {
            if (matchedResults.length === 0) {
                showToast('다운로드할 데이터가 없습니다.', 'error');
                return;
            }

            try {
                const dataWithHeader = [
                    ['과목코드', '성명', 'ID', '나이스 번호', '오프라인 성적', '과제 점수', '기수', '차시', '운영기관', '지역', '학교명'],
                    ...matchedResults.map(result => [
                        result.subjectCode,
                        result.participantName,
                        result.foundationId,
                        result.niceId,
                        result.offlineScore,
                        result.assignmentScore,
                        result.kisu,
                        result.operation,
                        result.organization,
                        result.region,
                        result.schoolName
                    ])
                ];

                const ws = XLSX.utils.aoa_to_sheet(dataWithHeader);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '매칭결과');
                
                const fileName = `출석부_나이스ID_매칭결과_${new Date().toISOString().slice(0, 10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                showToast('파일이 다운로드되었습니다!');
            } catch (error) {
                console.error('다운로드 오류:', error);
                showToast('다운로드 중 오류가 발생했습니다.', 'error');
            }
        }

        // 클립보드 복사
        async function copyToClipboard() {
            if (matchedResults.length === 0) {
                showToast('복사할 데이터가 없습니다.', 'error');
                return;
            }

            let clipboardText = '과목코드\t성명\tID\t나이스 번호\t오프라인 성적\t과제 점수\t기수\t차시\t운영기관\t지역\t학교명\n';
            
            matchedResults.forEach(result => {
                clipboardText += `${result.subjectCode}\t${result.participantName}\t${result.foundationId}\t${result.niceId}\t${result.offlineScore}\t${result.assignmentScore}\t${result.kisu}\t${result.operation}\t${result.organization}\t${result.region}\t${result.schoolName}\n`;
            });
            
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(clipboardText);
                    showToast('데이터가 클립보드에 복사되었습니다!');
                } else {
                    showToast('클립보드 복사가 지원되지 않습니다.', 'error');
                }
            } catch (err) {
                console.error('복사 실패:', err);
                showToast('복사에 실패했습니다.', 'error');
            }
        }

        // 토스트 메시지
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'error' : ''}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }
    </script>
</body>
</html>
